import { NextRequest, NextResponse } from 'next/server';\nimport { getAirtableKey, getAirtableBaseId, getAirtableLeadsTableId } from '@/lib/api-keys-service';\nimport { invalidateLeadCache } from '@/lib/cache';\nimport { LeadData } from '@/types/leads';\n\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\n\ninterface MergeRequest {\n  masterId: string;\n  duplicateIds: string[];\n  strategy?: 'keep-master' | 'keep-newest';\n}\n\n/**\n * Helper: Fetch lead record by ID from Airtable\n */\nasync function getLeadRecord(\n  apiKey: string,\n  baseId: string,\n  tableId: string,\n  leadId: string\n): Promise<any | null> {\n  try {\n    const url = `https://api.airtable.com/v0/${baseId}/${tableId}/${leadId}`;\n    const response = await fetch(url, {\n      headers: {\n        Authorization: `Bearer ${apiKey}`,\n        'Content-Type': 'application/json',\n      },\n    });\n\n    if (!response.ok) {\n      console.error(`‚ùå Failed to fetch lead ${leadId}: ${response.status}`);\n      return null;\n    }\n\n    return await response.json();\n  } catch (error) {\n    console.error(`‚ùå Error fetching lead ${leadId}:`, error);\n    return null;\n  }\n}\n\n/**\n * Helper: Update lead record in Airtable\n */\nasync function updateLeadRecord(\n  apiKey: string,\n  baseId: string,\n  tableId: string,\n  leadId: string,\n  fields: Record<string, any>\n): Promise<boolean> {\n  try {\n    const url = `https://api.airtable.com/v0/${baseId}/${tableId}/${leadId}`;\n    const response = await fetch(url, {\n      method: 'PATCH',\n      headers: {\n        Authorization: `Bearer ${apiKey}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({ fields }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(`‚ùå Failed to update lead ${leadId}: ${response.status} - ${errorText}`);\n      return false;\n    }\n\n    return true;\n  } catch (error) {\n    console.error(`‚ùå Error updating lead ${leadId}:`, error);\n    return false;\n  }\n}\n\n/**\n * Helper: Delete lead record from Airtable\n */\nasync function deleteLeadRecord(\n  apiKey: string,\n  baseId: string,\n  tableId: string,\n  leadId: string\n): Promise<boolean> {\n  try {\n    const url = `https://api.airtable.com/v0/${baseId}/${tableId}/${leadId}`;\n    const response = await fetch(url, {\n      method: 'DELETE',\n      headers: {\n        Authorization: `Bearer ${apiKey}`,\n        'Content-Type': 'application/json',\n      },\n    });\n\n    if (!response.ok) {\n      console.error(`‚ùå Failed to delete lead ${leadId}: ${response.status}`);\n      return false;\n    }\n\n    return true;\n  } catch (error) {\n    console.error(`‚ùå Error deleting lead ${leadId}:`, error);\n    return false;\n  }\n}\n\n/**\n * Helper: Consolidate fields from master and duplicates\n * Strategia: riempire i campi null del master con valori dai duplicati\n */\nfunction consolidateFields(masterRecord: any, duplicateRecords: any[]): Record<string, any> {\n  const masterFields = masterRecord.fields || {};\n  const consolidated = { ...masterFields };\n\n  // Campi da consolidare (non link fields)\n  const consolidatableFields = [\n    'Email',\n    'Telefono',\n    'Indirizzo',\n    'CAP',\n    'Citt√†',\n    'Esigenza',\n    'Note',\n  ];\n\n  for (const dupRecord of duplicateRecords) {\n    const dupFields = dupRecord.fields || {};\n\n    for (const field of consolidatableFields) {\n      // Se il campo master √® vuoto, prendi dal duplicato\n      if (!consolidated[field] && dupFields[field]) {\n        consolidated[field] = dupFields[field];\n      }\n    }\n  }\n\n  return consolidated;\n}\n\n/**\n * Helper: Merge relazioni (Ordini, Attivit√†)\n * Raccoglie tutti gli ordini e attivit√† dai duplicati\n */\nfunction mergeRelations(masterRecord: any, duplicateRecords: any[]): {\n  ordersToUpdate: string[];\n  activitiesToUpdate: string[];\n} {\n  const masterFields = masterRecord.fields || {};\n\n  const masterOrders = new Set(masterFields['Orders'] || []);\n  const masterActivities = new Set(masterFields['Attivit√†'] || []);\n\n  // Raccogli ordini e attivit√† dai duplicati\n  for (const dupRecord of duplicateRecords) {\n    const dupFields = dupRecord.fields || {};\n\n    (dupFields['Orders'] || []).forEach((orderId: string) => masterOrders.add(orderId));\n    (dupFields['Attivit√†'] || []).forEach((actId: string) => masterActivities.add(actId));\n  }\n\n  return {\n    ordersToUpdate: Array.from(masterOrders),\n    activitiesToUpdate: Array.from(masterActivities),\n  };\n}\n\n/**\n * POST /api/leads/merge\n * Unisce lead duplicati in un master lead\n *\n * Body:\n * {\n *   \"masterId\": \"recXXX\",\n *   \"duplicateIds\": [\"recYYY\", \"recZZZ\"],\n *   \"strategy\": \"keep-master\" | \"keep-newest\"\n * }\n *\n * Response:\n * {\n *   \"success\": true,\n *   \"mergedLeadId\": \"recXXX\",\n *   \"mergedCount\": 2,\n *   \"preservedRelations\": {\n *     \"orders\": 5,\n *     \"activities\": 10\n *   }\n * }\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const body: MergeRequest = await request.json();\n    const { masterId, duplicateIds = [], strategy = 'keep-master' } = body;\n\n    console.log('üîó [Merge API] Starting merge operation');\n    console.log(`  Master: ${masterId}`);\n    console.log(`  Duplicates: ${duplicateIds.join(', ')}`);\n    console.log(`  Strategy: ${strategy}`);\n\n    // Validazione input\n    if (!masterId || !duplicateIds || duplicateIds.length === 0) {\n      console.error('‚ùå [Merge API] Invalid request: missing masterId or duplicateIds');\n      return NextResponse.json(\n        { error: 'masterId e duplicateIds sono obbligatori' },\n        { status: 400 }\n      );\n    }\n\n    if (duplicateIds.includes(masterId)) {\n      console.error('‚ùå [Merge API] Invalid request: masterId √® anche nei duplicateIds');\n      return NextResponse.json(\n        { error: 'masterId non pu√≤ essere nei duplicateIds' },\n        { status: 400 }\n      );\n    }\n\n    // Get API credentials\n    const apiKey = await getAirtableKey();\n    const baseId = await getAirtableBaseId();\n    const tableId = await getAirtableLeadsTableId();\n\n    if (!apiKey || !baseId || !tableId) {\n      console.error('‚ùå [Merge API] Missing Airtable credentials');\n      return NextResponse.json(\n        { error: 'Missing Airtable credentials' },\n        { status: 500 }\n      );\n    }\n\n    // 1. Fetch all records (master + duplicates)\n    console.log('üì° [Merge API] Fetching records...');\n    const masterRecord = await getLeadRecord(apiKey, baseId, tableId, masterId);\n    if (!masterRecord) {\n      return NextResponse.json(\n        { error: `Master lead ${masterId} non trovato` },\n        { status: 404 }\n      );\n    }\n\n    const duplicateRecords: any[] = [];\n    for (const dupId of duplicateIds) {\n      const dupRecord = await getLeadRecord(apiKey, baseId, tableId, dupId);\n      if (dupRecord) {\n        duplicateRecords.push(dupRecord);\n      }\n    }\n\n    if (duplicateRecords.length === 0) {\n      console.error('‚ùå [Merge API] Nessuno dei duplicateIds trovato');\n      return NextResponse.json(\n        { error: 'Nessuno dei lead duplicati trovato' },\n        { status: 404 }\n      );\n    }\n\n    // 2. Consolidate fields\n    console.log('üìù [Merge API] Consolidating fields...');\n    const consolidatedFields = consolidateFields(masterRecord, duplicateRecords);\n\n    // 3. Merge relations (Orders, Activities)\n    console.log('üîó [Merge API] Merging relations...');\n    const { ordersToUpdate, activitiesToUpdate } = mergeRelations(masterRecord, duplicateRecords);\n\n    // Aggiorna il master lead con campi consolidati e relazioni\n    consolidatedFields['Orders'] = ordersToUpdate;\n    consolidatedFields['Attivit√†'] = activitiesToUpdate;\n\n    const updateSuccess = await updateLeadRecord(apiKey, baseId, tableId, masterId, consolidatedFields);\n    if (!updateSuccess) {\n      console.error('‚ùå [Merge API] Failed to update master lead');\n      return NextResponse.json(\n        { error: 'Failed to update master lead' },\n        { status: 500 }\n      );\n    }\n\n    // 4. Delete duplicate records\n    console.log('üóëÔ∏è [Merge API] Deleting duplicate records...');\n    const deletedCount = duplicateRecords.length;\n    for (const dupRecord of duplicateRecords) {\n      const deleteSuccess = await deleteLeadRecord(apiKey, baseId, tableId, dupRecord.id);\n      if (!deleteSuccess) {\n        console.warn(`‚ö†Ô∏è [Merge API] Failed to delete duplicate ${dupRecord.id}`);\n      }\n    }\n\n    // 5. Invalidate cache\n    console.log('üíæ [Merge API] Invalidating cache...');\n    await invalidateLeadCache();\n\n    // 6. Log success\n    console.log('‚úÖ [Merge API] Merge completed successfully');\n    console.log(`  Merged ${deletedCount} duplicates into ${masterId}`);\n    console.log(`  Orders: ${ordersToUpdate.length}`);\n    console.log(`  Activities: ${activitiesToUpdate.length}`);\n\n    return NextResponse.json(\n      {\n        success: true,\n        mergedLeadId: masterId,\n        mergedCount: deletedCount,\n        preservedRelations: {\n          orders: ordersToUpdate.length,\n          activities: activitiesToUpdate.length,\n        },\n        message: `${deletedCount} lead uniti con successo in ${masterRecord.fields.Nome}`,\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('‚ùå [Merge API] Error:', error);\n    return NextResponse.json(\n      {\n        error: 'Failed to merge leads',\n        details: error instanceof Error ? error.message : 'Unknown error',\n      },\n      { status: 500 }\n    );\n  }\n}\n"}