import { NextRequest, NextResponse } from 'next/server';\nimport { getAirtableKey, getAirtableBaseId, getAirtableLeadsTableId } from '@/lib/api-keys-service';\nimport { leadsCache } from '@/lib/leads-cache';\nimport { detectDuplicates, DuplicateGroup } from '@/lib/lead-deduplication';\n\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\n\n/**\n * GET /api/leads/duplicates\n * Rileva lead duplicati nel database\n *\n * Query params:\n * - ?threshold=0.85 (fuzzy matching threshold, default 0.85)\n * - ?exactOnly=true (solo exact matches, ignora fuzzy)\n *\n * Response:\n * {\n *   \"success\": true,\n *   \"duplicates\": [\n *     {\n *       \"masterLead\": { id, Nome, Telefono, ... },\n *       \"duplicateLeads\": [ { id, Nome, Telefono, ... }, ... ],\n *       \"matchType\": \"exact\" | \"fuzzy\",\n *       \"similarity\": 1 | 0.85\n *     }\n *   ],\n *   \"count\": 3,\n *   \"cacheHit\": true\n * }\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams;\n    const threshold = parseFloat(searchParams.get('threshold') || '0.85');\n    const exactOnly = searchParams.get('exactOnly') === 'true';\n\n    console.log('üîç [Duplicates API] Starting detection');\n    console.log(`üìä Threshold: ${threshold}, Exact only: ${exactOnly}`);\n\n    // 1. Recupera lead dalla cache o da Airtable\n    let leads = await leadsCache.getAll();\n    let cacheHit = true;\n\n    if (!leads || leads.length === 0) {\n      console.log('üì° [Duplicates API] Cache miss, fetching from Airtable...');\n      cacheHit = false;\n\n      const apiKey = await getAirtableKey();\n      const baseId = await getAirtableBaseId();\n      const tableId = await getAirtableLeadsTableId();\n\n      if (!apiKey || !baseId || !tableId) {\n        return NextResponse.json(\n          { error: 'Missing Airtable credentials' },\n          { status: 500 }\n        );\n      }\n\n      // Fetch all records\n      const params = new URLSearchParams();\n      params.set('loadAll', 'true');\n\n      const airtableUrl = `https://api.airtable.com/v0/${baseId}/${tableId}?${params.toString()}`;\n\n      const response = await fetch(airtableUrl, {\n        headers: {\n          Authorization: `Bearer ${apiKey}`,\n          'Content-Type': 'application/json',\n        },\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(`‚ùå [Duplicates API] Airtable error: ${response.status} - ${errorText}`);\n        return NextResponse.json(\n          { error: 'Failed to fetch leads from Airtable' },\n          { status: 500 }\n        );\n      }\n\n      const data = await response.json();\n      leads = (data.records || []).map((record: any) => ({\n        id: record.id,\n        createdTime: record.createdTime,\n        ...record.fields,\n      }));\n\n      console.log(`‚úÖ [Duplicates API] Fetched ${leads.length} leads from Airtable`);\n    } else {\n      console.log(`‚úÖ [Duplicates API] Using ${leads.length} leads from cache`);\n    }\n\n    // 2. Rileva duplicati\n    console.log('üîé [Duplicates API] Running deduplication algorithm...');\n    let groups = detectDuplicates(leads, threshold);\n\n    // 3. Filtra solo exact matches se richiesto\n    if (exactOnly) {\n      groups = groups.filter(g => g.matchType === 'exact');\n      console.log(`üîê [Duplicates API] Filtered to exact matches only: ${groups.length}`);\n    }\n\n    console.log(`üìä [Duplicates API] Found ${groups.length} duplicate groups`);\n\n    // 4. Log dettagli\n    for (const group of groups) {\n      console.log(\n        `  - ${group.masterLead.Nome} (${group.matchType}, ${(group.similarity * 100).toFixed(0)}%): ${group.duplicateLeads.length} duplicati`\n      );\n    }\n\n    return NextResponse.json(\n      {\n        success: true,\n        duplicates: groups,\n        count: groups.length,\n        totalLeads: leads.length,\n        cacheHit,\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error('‚ùå [Duplicates API] Error:', error);\n    return NextResponse.json(\n      {\n        error: 'Failed to detect duplicates',\n        details: error instanceof Error ? error.message : 'Unknown error',\n      },\n      { status: 500 }\n    );\n  }\n}\n"}