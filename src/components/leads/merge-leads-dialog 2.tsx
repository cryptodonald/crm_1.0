'use client';\n\nimport { useState, useMemo } from 'react';\nimport { LeadData } from '@/types/leads';\nimport { useMergeLeads } from '@/hooks/use-merge-leads';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';\nimport { Label } from '@/components/ui/label';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { AlertTriangle, CheckCircle2, Link2, Loader2 } from 'lucide-react';\n\ninterface MergeLeadsDialogProps {\n  open: boolean;\n  leads: LeadData[];\n  onOpenChange: (open: boolean) => void;\n  onMergeComplete?: () => void;\n}\n\nexport function MergeLeadsDialog({\n  open,\n  leads,\n  onOpenChange,\n  onMergeComplete,\n}: MergeLeadsDialogProps) {\n  const [step, setStep] = useState<'select-master' | 'preview' | 'confirm'>('select-master');\n  const [selectedMasterId, setSelectedMasterId] = useState<string>(leads[0]?.id || '');\n  const { mergeLead, merging } = useMergeLeads();\n\n  // Identify master and duplicates\n  const { master, duplicates } = useMemo(() => {\n    const master = leads.find(l => l.id === selectedMasterId) || leads[0];\n    const duplicates = leads.filter(l => l.id !== master?.id);\n    return { master, duplicates };\n  }, [leads, selectedMasterId]);\n\n  // Preview consolidation\n  const preview = useMemo(() => {\n    if (!master) return null;\n\n    const fields = [\n      'Email',\n      'Telefono',\n      'Indirizzo',\n      'CAP',\n      'Città',\n      'Esigenza',\n      'Note',\n    ] as const;\n\n    const consolidation = fields.map(field => {\n      const masterValue = (master as any)[field];\n      const sources = duplicates\n        .map(dup => ({\n          nome: dup.Nome,\n          valore: (dup as any)[field],\n        }))\n        .filter(s => s.valore && !masterValue);\n\n      return {\n        field,\n        masterValue,\n        sources,\n      };\n    });\n\n    return consolidation;\n  }, [master, duplicates]);\n\n  // Handle merge\n  const handleMerge = async () => {\n    if (!master) return;\n\n    const success = await mergeLead(\n      master.id,\n      duplicates.map(d => d.id)\n    );\n\n    if (success) {\n      onOpenChange(false);\n      onMergeComplete?.();\n      // Reset dialog state\n      setStep('select-master');\n      setSelectedMasterId(leads[0]?.id || '');\n    }\n  };\n\n  if (!master) return null;\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-2xl\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Link2 className=\"h-5 w-5\" />\n            Unisci Lead Duplicati\n          </DialogTitle>\n          <DialogDescription>\n            Stai per unire {duplicates.length} lead in \"{master.Nome}\"\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-6 py-4\">\n          {/* Step Indicator */}\n          <div className=\"flex gap-2\">\n            <Button\n              variant={step === 'select-master' ? 'default' : 'outline'}\n              size=\"sm\"\n              onClick={() => setStep('select-master')}\n              disabled={merging}\n            >\n              1. Seleziona Master\n            </Button>\n            <Button\n              variant={step === 'preview' ? 'default' : 'outline'}\n              size=\"sm\"\n              onClick={() => setStep('preview')}\n              disabled={merging || !selectedMasterId}\n            >\n              2. Anteprima\n            </Button>\n            <Button\n              variant={step === 'confirm' ? 'default' : 'outline'}\n              size=\"sm\"\n              onClick={() => setStep('confirm')}\n              disabled={merging || !selectedMasterId}\n            >\n              3. Conferma\n            </Button>\n          </div>\n\n          {/* STEP 1: Select Master */}\n          {step === 'select-master' && (\n            <div className=\"space-y-4\">\n              <Alert>\n                <AlertTriangle className=\"h-4 w-4\" />\n                <AlertDescription>\n                  Seleziona quale lead mantenere come \"principale\". Gli altri verranno consolidati in questo.\n                </AlertDescription>\n              </Alert>\n\n              <RadioGroup value={selectedMasterId} onValueChange={setSelectedMasterId}>\n                <div className=\"space-y-3\">\n                  {leads.map(lead => (\n                    <div key={lead.id} className=\"flex items-center space-x-3 rounded-lg border p-3 cursor-pointer hover:bg-muted/50\">\n                      <RadioGroupItem value={lead.id} id={`master-${lead.id}`} />\n                      <Label\n                        htmlFor={`master-${lead.id}`}\n                        className=\"flex-1 cursor-pointer\"\n                      >\n                        <div className=\"font-medium\">{lead.Nome}</div>\n                        <div className=\"text-sm text-muted-foreground\">\n                          {lead.Telefono && `Tel: ${lead.Telefono}`}\n                          {lead.Email && ` | Email: ${lead.Email}`}\n                        </div>\n                      </Label>\n                      {lead.id === selectedMasterId && (\n                        <Badge variant=\"default\">Master</Badge>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              </RadioGroup>\n\n              <Button\n                className=\"w-full\"\n                onClick={() => setStep('preview')}\n              >\n                Avanti\n              </Button>\n            </div>\n          )}\n\n          {/* STEP 2: Preview Consolidation */}\n          {step === 'preview' && (\n            <div className=\"space-y-4\">\n              <Alert>\n                <CheckCircle2 className=\"h-4 w-4\" />\n                <AlertDescription>\n                  Ecco come verranno consolidati i dati. I campi vuoti del master saranno riempiti con dati dai duplicati.\n                </AlertDescription>\n              </Alert>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-lg\">Lead Master: {master.Nome}</CardTitle>\n                  <CardDescription>I dati verranno consolidati qui</CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  {preview?.map(item => (\n                    <div key={item.field} className=\"space-y-2\">\n                      <div className=\"font-medium text-sm\">{item.field}</div>\n                      <div className=\"ml-4 space-y-2\">\n                        {item.masterValue ? (\n                          <div className=\"rounded bg-green-50 p-2 text-sm\">\n                            <span className=\"font-medium\">Master:</span> {String(item.masterValue)}\n                          </div>\n                        ) : (\n                          <div className=\"rounded bg-gray-50 p-2 text-sm text-muted-foreground\">\n                            (vuoto)\n                          </div>\n                        )}\n\n                        {item.sources.length > 0 && (\n                          <div className=\"space-y-1\">\n                            {item.sources.map((source, idx) => (\n                              <div key={idx} className=\"rounded bg-blue-50 p-2 text-sm\">\n                                <span className=\"font-medium text-blue-700\">{source.nome}:</span> {String(source.valore)}\n                              </div>\n                            ))}\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  ))}\n                </CardContent>\n              </Card>\n\n              <div className=\"flex gap-2\">\n                <Button\n                  variant=\"outline\"\n                  className=\"flex-1\"\n                  onClick={() => setStep('select-master')}\n                >\n                  Indietro\n                </Button>\n                <Button\n                  className=\"flex-1\"\n                  onClick={() => setStep('confirm')}\n                >\n                  Procedi a Conferma\n                </Button>\n              </div>\n            </div>\n          )}\n\n          {/* STEP 3: Confirm */}\n          {step === 'confirm' && (\n            <div className=\"space-y-4\">\n              <Alert>\n                <AlertTriangle className=\"h-4 w-4\" />\n                <AlertDescription>\n                  Questa azione è irreversibile. Saranno eliminati {duplicates.length} lead e consolidati in \"{master.Nome}\".\n                </AlertDescription>\n              </Alert>\n\n              <Card className=\"border-yellow-200 bg-yellow-50\">\n                <CardHeader>\n                  <CardTitle className=\"text-base\">Riepilogo Merge</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-2 text-sm\">\n                  <div>\n                    <span className=\"font-medium\">Lead Master:</span> {master.Nome}\n                  </div>\n                  <div>\n                    <span className=\"font-medium\">Lead da unire:</span> {duplicates.length}\n                    <div className=\"ml-4 space-y-1 mt-1\">\n                      {duplicates.map(d => (\n                        <div key={d.id} className=\"text-muted-foreground\">\n                          • {d.Nome}\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                  <div className=\"pt-2 border-t\">\n                    <span className=\"font-medium\">Relazioni preserve:</span>\n                    <div className=\"ml-4 text-muted-foreground\">\n                      • Tutti gli ordini e le attività verranno associati al master\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <div className=\"flex gap-2\">\n                <Button\n                  variant=\"outline\"\n                  className=\"flex-1\"\n                  onClick={() => setStep('preview')}\n                  disabled={merging}\n                >\n                  Indietro\n                </Button>\n                <Button\n                  className=\"flex-1 bg-destructive hover:bg-destructive/90\"\n                  onClick={handleMerge}\n                  disabled={merging}\n                >\n                  {merging ? (\n                    <>\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      Unendo...\n                    </>\n                  ) : (\n                    'Conferma Merge'\n                  )}\n                </Button>\n              </div>\n            </div>\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n"}